#Libraries:
library(dplyr)
library(tidyverse)
library(tibble)
library(stringr)
library(ggplot2)
library(RColorBrewer)

#Data Wrangling: Join add group column to OTUs Table.
OTU_group = Table_S2_Egge_et_al_2015_jeukmic %>%
  mutate(OTU_id = str_replace(`OTU id`,"OTU\\s", "OTU\\_")) %>% 
  select(OTU_id, Group)

data = OTU_group %>%
  right_join(MEC_14_1145_OTUtab_piconanopool_subsamp5553_correctversion,
             by = 'OTU_id') %>% 
  select(!Rownames) %>% 
  pivot_longer(cols = Sep09:June11,
               names_to = "Month",
               values_to = "Count")
  
group_count = data %>% 
  select(Group, Count) %>% 
  group_by(Group) %>% 
  summarise(Count_group = sum(Count))

month_count = data %>% 
  select(Month, Count) %>% 
  group_by(Month) %>% 
  summarise(Count_month = sum(Count))

data = data %>%
  right_join(month_count,
             by = 'Month') %>% 
  right_join(group_count,
             by = 'Group')
data = data %>% 
  mutate(Frequency = Count / Count_month)
  
#Data visualization:
data %>% 
  ggplot(aes(x = Month,
             y = OTU_id,
             fill = Frequency)) +
  geom_tile() +
  scale_fill_distiller(palette = "RdPu") +
  labs(title = "Figure 5",
       x = "Months", legend = "Proportional read abundance") +
theme(axis.text.x = element_text(angle = 90, hjust = 1),
  axis.title.y = element_blank())
  
  